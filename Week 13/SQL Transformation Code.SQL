CREATE TABLE WEEK13_2024_INPUT
	(SALES_DATE DATE,
    PRODUCT VARCHAR(64),
    PRICE DOUBLE,
    QUANTITY_SOLD INT);

INSERT INTO WEEK13_2020_INPUT VALUES ();

CREATE TABLE WEEK13_202X_INPUTS AS 
	SELECT * FROM week13_2020_input
		UNION ALL
	SELECT * FROM week13_2021_input
		UNION ALL
	SELECT * FROM week13_2022_input
		UNION ALL
	SELECT * FROM week13_2023_input
		UNION ALL
	SELECT * FROM week13_2024_input;

UPDATE week13_202x_inputs 
SET SALES_DATE = str_to_date(SALES_DATE, '%c/%e/%y');

WITH CTE AS(
SELECT *, date_format(SALES_DATE, '%Y-%U') AS WEEK_NUMBER
FROM week13_202x_inputs),
WEEK_NUMBER AS (
	SELECT DISTINCT 
		WEEK_NUMBER, 
        COUNT(WEEK_NUMBER) OVER (ORDER BY WEEK_NUMBER) AS NEW_NUMBER
	FROM CTE
    GROUP BY WEEK_NUMBER),
NEW_WEEK_NUMBER AS (
SELECT
	WEEK_NUMBER,
    NEW_NUMBER - REGEXP_SUBSTR(WEEK_NUMBER, '(.)',4)*12 AS NEWBIE
FROM WEEK_NUMBER)

SELECT 
	SALES_DATE,
    NEWBIE AS WEEK_NUMBER,
    LEFT(DATE_FORMAT(SALES_DATE, '%W'),2) AS DAY_LETTER,
    DATE_FORMAT(SALES_DATE, '%w') AS DAY_NUMBER,
    PRODUCT,
    PRICE,
    QUANTITY_SOLD,
	PRICE*QUANTITY_SOLD AS SALES
FROM CTE
	JOIN WEEK_NUMBER AS B
		ON CTE.WEEK_NUMBER = B.WEEK_NUMBER
	JOIN NEW_WEEK_NUMBER AS C ON B.WEEK_NUMBER=C.WEEK_NUMBER
ORDER BY SALES_DATE

