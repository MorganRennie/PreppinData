

-- CREATE TABLE AND INSERT VALUES 
CREATE TABLE STAFFPAY 
(`STAFFID` INT, `1` DOUBLE, `2` DOUBLE, `3` DOUBLE, `4` DOUBLE, `5` DOUBLE, `6` DOUBLE, `7` DOUBLE, `8` DOUBLE, `9` DOUBLE, `10` DOUBLE, `11` DOUBLE, `12` DOUBLE);

 -- PROVIDE ROW NUMBERS
CREATE VIEW STAFFROWID AS
SELECT
    *,
    ROW_NUMBER() OVER (ORDER BY `1`) AS  `ROW_NUMBER`
FROM STAFFPAY;

-- USING THESE ROW NUMBERS, SELECT THE MOST RECENT ROW AND FIND THE STAFF'S ANNUAL SALARY
CREATE VIEW STAFFSALARY AS
  WITH CTE AS (
    SELECT 
        MAX(`ROW_NUMBER`) AS `LATEST_ROW`,
        STAFFID 
    FROM STAFFROWID
    GROUP BY STAFFID)
SELECT
    A.STAFFID,
    ROUND(SUM(`1` + `2` + `3` + `4` + `5` + `6` + `7` + `8` + `9` + `10` + `11` + `12`), 2) AS ANNUAL_SALARY
FROM STAFFROWID AS A
  JOIN CTE ON A.ROW_NUMBER = LATEST_ROW
  GROUP BY A.STAFFID;

 -- USING THE PROVIDED TAX BANDS, FIND THE STAFF'S MAX TAX BAND, AND FIND HOW MUCH THE STAFF WILL PAY IN EACH TAX BAND. 
WITH CTE AS (
    SELECT
        STAFFID,
        ANNUAL_SALARY,
        CASE 
            WHEN ANNUAL_SALARY > 125140 THEN '45% RATE'
            WHEN ANNUAL_SALARY <= 125140 AND ANNUAL_SALARY >= 50271 THEN '40% RATE'
            WHEN ANNUAL_SALARY <= 50270 AND ANNUAL_SALARY >= 12571 THEN '20% RATE'
            WHEN ANNUAL_SALARY <= 12570 THEN '0% RATE'
        END AS MAX_TAX_BAND,
        CASE 
            WHEN ANNUAL_SALARY <= 12570 THEN 0.00
            WHEN ANNUAL_SALARY <= 50270 THEN ROUND((ANNUAL_SALARY - 12570) * 0.2, 2)
            WHEN ANNUAL_SALARY > 50270 THEN 7539.80
        END AS `20%_TAX_RATE`,
        CASE 
            WHEN ANNUAL_SALARY <= 50270 THEN 0.00
            WHEN ANNUAL_SALARY <= 125140 THEN ROUND((ANNUAL_SALARY - 50270) * 0.4, 2)
            WHEN ANNUAL_SALARY > 125140 THEN 29948.00
        END AS `40%_TAX_RATE`,
        CASE 
            WHEN ANNUAL_SALARY <= 125140 THEN 0.00
            WHEN ANNUAL_SALARY > 125140 THEN ROUND((ANNUAL_SALARY - 125140) * 0.45, 2)
        END AS `45%_TAX_RATE`
    FROM STAFFSALARY
    GROUP BY STAFFID, ANNUAL_SALARY
)
  -- USING THE TAX BANDING CALCULATIONS IN THE ABOVE CTE, FIND THE TOTAL TAX PAID. 
SELECT 
    *,
    ROUND(SUM(`20%_TAX_RATE` + `40%_TAX_RATE` + `45%_TAX_RATE`), 2) AS TOTAL_TAX_PAID
FROM CTE 
GROUP BY STAFFID, ANNUAL_SALARY, MAX_TAX_BAND, `20%_TAX_RATE`, `40%_TAX_RATE`, `45%_TAX_RATE`;
